---
title: "Linear_mixed_models_functional_groups"
author: "Hannah SÃ¸rine Gerlich"
format: html
editor: visual
---

# Analyses of phenological responses to snowmelt timing and temperature among functional groups

This file contains all the code necessary to perform linear mixed modelling on the effect of temperature and snowmelt on phenology among functional groups and arthropods with specific traits.

Initially, we load all the relevant packages.

```{r}
pkgs <- c("tidyverse", "readxl", "stats", "lme4", "lmerTest", "car",
          "sjPlot", "MASS", "gtsummary")

vapply(pkgs, library, FUN.VALUE = logical(1L), character.only = TRUE,
       logical.return = TRUE)
```

```{r}
df_phen_event <-
  read.csv(
    "Data/Pheno_air_temp.csv",
    sep = ",",
    stringsAsFactors = FALSE,
    header = TRUE
  )

dfsnowmelt_climatestation <-
  readxl::read_xlsx("Data/Snowmelt_climatestation.xlsx")

df_phen_event$Snowmelt <-
  dfsnowmelt_climatestation$DOY[match(paste0(df_phen_event$Year),
                                      paste0(dfsnowmelt_climatestation$Year))]
```

Assign functional groups and traits.

```{r}
df_phen_event %>%
  mutate(Order = case_when(
    SpeciesID == "Acari" ~ "Decomposer",
    SpeciesID == "ANMU" ~ "Mixed feeder",
    SpeciesID == "Aphidoidea" ~ "Herbivor",
    SpeciesID == "Chalcidoidea" ~ "Parasitoid",
    SpeciesID == "CHCE" ~ "Mixed feeder",
    SpeciesID == "Coccoidea" ~ "Herbivor",
    SpeciesID == "Collembola" ~ "Decomposer",
    SpeciesID == "Culicidae" ~ "Mixed feeder",
    SpeciesID == "Ichneumonidae" ~ "Parasitoid",
    SpeciesID == "Linyphiidae" ~ "Predator",
    SpeciesID == "Lycosidae" ~ "Predator",
    SpeciesID == "MYSC" ~ "Mixed feeder",
    SpeciesID == "Nymphalidae" ~ "Mixed feeder",
    SpeciesID == "Phoridae" ~ "Mixed feeder",
    SpeciesID == "Scathophagidae" ~ "Mixed feeder",
    SpeciesID == "Thomisidae" ~ "Predator")) -> df_phen_event

df_phen_event %>%
  mutate(Emerge = case_when(
    SpeciesID == "Acari" ~ "Early",
    SpeciesID == "ANMU" ~ "Late",
    SpeciesID == "Aphidoidea" ~ "Late",
    SpeciesID == "Chalcidoidea" ~ "Late",
    SpeciesID == "CHCE" ~ "Early",
    SpeciesID == "Coccoidea" ~ "Late",
    SpeciesID == "Collembola" ~ "Early",
    SpeciesID == "Culicidae" ~ "Late",
    SpeciesID == "Ichneumonidae" ~ "Late",
    SpeciesID == "Linyphiidae" ~ "Early",
    SpeciesID == "Lycosidae" ~ "Early",
    SpeciesID == "MYSC" ~ "Early",
    SpeciesID == "Nymphalidae" ~ "Late",
    SpeciesID == "Phoridae" ~ "Late",
    SpeciesID == "Scathophagidae" ~ "Late",
    SpeciesID == "Thomisidae" ~ "Early")) -> df_phen_event

df_phen_event %>%
  mutate(Trait = case_when(
    SpeciesID == "Acari" ~ "Surface",
    SpeciesID == "ANMU" ~ "Flying",
    SpeciesID == "Aphidoidea" ~ "Surface",
    SpeciesID == "Chalcidoidea" ~ "Flying",
    SpeciesID == "CHCE" ~ "Flying",
    SpeciesID == "Coccoidea" ~ "Surface",
    SpeciesID == "Collembola" ~ "Surface",
    SpeciesID == "Culicidae" ~ "Flying",
    SpeciesID == "Ichneumonidae" ~ "Flying",
    SpeciesID == "Linyphiidae" ~ "Surface",
    SpeciesID == "Lycosidae" ~ "Surface",
    SpeciesID == "MYSC" ~ "Flying",
    SpeciesID == "Nymphalidae" ~ "Flying",
    SpeciesID == "Phoridae" ~ "Flying",
    SpeciesID == "Scathophagidae" ~ "Flying",
    SpeciesID == "Thomisidae" ~ "Surface")) -> df_phen_event
```

We find strong collinearity between temperature and snowmelt for families in the snowbed plot (Art6) and Nymphalidae in one mesic heath plot (Art3). We also do not consider phenology observations for spiders (predators) and decomposers in the window trap (Plot 1) reliable. Therefore, we have to remove these observations from the data.

```{r}
df_phen_event <-
  df_phen_event[!(df_phen_event$Plot == "Art1" &
                    (df_phen_event$Order == "Decomposer")), ]
df_phen_event <-
  df_phen_event[!(df_phen_event$Plot == "Art1" &
                    (df_phen_event$Order == "Predator")), ]
df_phen_event <-
  df_phen_event[!(df_phen_event$Plot == "Art3" &
                    (df_phen_event$SpeciesID == "Nymphalidae")), ]
df_phen_event <-
  df_phen_event[!(df_phen_event$SpeciesID == "Lygaeidae"), ]

df_phen_event <- subset(df_phen_event,!Plot == "Art6")
```

Assign habitat types.

```{r}
df_phen_event %>%
  mutate(
    Habitat = case_when(
      Plot == "Art1" ~ "Pond",
      Plot == "Art2" ~ "Wet fen",
      Plot == "Art3" ~ "Mesic heath",
      Plot == "Art4" ~ "Mesic heath",
      Plot == "Art5" ~ "Arid heath",
      Plot == "Art7" ~ "Arid heath"
    )
  ) -> df_phen_event
```

Remove taxa in the dataset for which we do not have enough data. These omly contain NA values.

```{r}
df_phen_event$Order[is.na(df_phen_event$Order)] <- "NA"
df_phen_event <- subset(df_phen_event, Order != "NA")
```

Because the temperature variable is specific for each taxon-by-plot combination, we need to account for within subject variation. Other than that, we also have to add year as a covariate to detrend the model.

```{r}
df_phen_event$speciesplot <-
  as.factor(paste(df_phen_event$SpeciesID, df_phen_event$Plot))

df_phen_event$Peak_Temp_new <-
  df_phen_event$Peak_Temp30 - tapply(df_phen_event$Peak_Temp30, df_phen_event$speciesplot, mean)[df_phen_event$speciesplot]
df_phen_event$Onset_Temp_new <-
  df_phen_event$Onset_Temp30 - tapply(df_phen_event$Onset_Temp30, df_phen_event$speciesplot, mean)[df_phen_event$speciesplot]
df_phen_event$End_Temp_new <-
  df_phen_event$End_Temp30 - tapply(df_phen_event$End_Temp30, df_phen_event$speciesplot, mean)[df_phen_event$speciesplot]
```

First, we test differences in **peak** phenological responses to climate variables among functional groups.

```{r}
df_phen_event$Order <- as.factor(df_phen_event$Order)
#contrasts(df_phen_event$Plot) <- contr.treatment(7, base = 1)
contrasts(df_phen_event$Order) <- contr.treatment(5, base = 1)



model_decomp <- lmer(Peak ~ 1 + Snowmelt*Order + Peak_Temp_new*Order + Year + (1 | Year) + (1 | SpeciesID:Plot) + (1 + Snowmelt + Peak_Temp_new | SpeciesID:Plot), data=df_phen_event)
summary(model_decomp)
anova(model_decomp)

tab_model(model_decomp, show.intercept = TRUE, show.est = TRUE, show.se = TRUE, show.p = TRUE, show.stat = TRUE, show.ci = FALSE,
          terms = c("(Intercept)", "Snowmelt", "Peak_Temp_new", "Year", "Order2", "Order3", "Order4", "Order5", "Snowmelt:Order2",  "Snowmelt:Order3",  "Snowmelt:Order4", "Snowmelt:Order5", "Order2:Peak_Temp_new",  "Order3:Peak_Temp_new",  "Order4:Peak_Temp_new", "Order5:Peak_Temp_new"),
         pred.labels = c("Intercept", "Snowmelt", "Herbivore", "Parasitoid", "Mixed feeder", "Predator",
                         "Temp", "Year", "Snowmelt:Herbivore", "Snowmelt:Parasitoid", "Snowmelt:Mixed feeder", "Snowmelt:Predator", "Temp:Herbivore", "Temp:Parasitoid", "Temp:Mixed feeder", "Temp:Predator"), title = "Peak ~ Snowmelt*Group + Temp*Group + Year + (1 | Year) + (1 | Taxa:Plot) + (1 + Temp + Snowmelt | Taxa:Plot)", dv.labels = "Compared group: Decomposer", string.est = "Coeff", string.se = "SE", string.stat = "t", string.p = "P-Value")
```
