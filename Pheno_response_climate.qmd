---
title: "Pheno_responses_climate"
author: "Hannah SÃ¸rine Gerlich"
format: html
editor: visual
message: false
warning: false
output: false
---

# Analyses on the effect of temperature and snowmelt on high-arctic arthropod phenology

This file contains all the code necessary to perform linear mixed modelling on the effect of temperature and snowmelt on high-arctic arthropod phenology.

Initially, we load all the relevant packages.

```{r}
pkgs <- c("tidyverse", "readxl", "corrplot", "stats", "lme4", "lmerTest", "car",
          "sjPlot")

vapply(pkgs, library, FUN.VALUE = logical(1L), character.only = TRUE,
       logical.return = TRUE)
```

Then read dataset with phenological metrics as well as air temperature estimates. The snowmelt data is in a separate csv file and we first have to bind the columns.

```{r}
df_phen_event <-
  read.csv(
    "Data/Pheno_air_temp.csv",
    sep = ",",
    stringsAsFactors = FALSE,
    header = TRUE
  )

dfsnowmelt_climatestation <-
  readxl::read_xlsx("Data/Snowmelt_climatestation.xlsx")

df_phen_event$Snowmelt <-
  dfsnowmelt_climatestation$DOY[match(paste0(df_phen_event$Year),
                                      paste0(dfsnowmelt_climatestation$Year))]
```

Assign functional groups and traits.

```{r}
df_phen_event %>%
  mutate(Order = case_when(
    SpeciesID == "Acari" ~ "Decomposer",
    SpeciesID == "ANMU" ~ "Mixed feeder",
    SpeciesID == "Aphidoidea" ~ "Herbivor",
    SpeciesID == "Chalcidoidea" ~ "Parasitoid",
    SpeciesID == "CHCE" ~ "Mixed feeder",
    SpeciesID == "Coccoidea" ~ "Herbivor",
    SpeciesID == "Collembola" ~ "Decomposer",
    SpeciesID == "Culicidae" ~ "Mixed feeder",
    SpeciesID == "Ichneumonidae" ~ "Parasitoid",
    SpeciesID == "Linyphiidae" ~ "Predator",
    SpeciesID == "Lycosidae" ~ "Predator",
    SpeciesID == "MYSC" ~ "Mixed feeder",
    SpeciesID == "Nymphalidae" ~ "Mixed feeder",
    SpeciesID == "Phoridae" ~ "Mixed feeder",
    SpeciesID == "Scathophagidae" ~ "Mixed feeder",
    SpeciesID == "Thomisidae" ~ "Predator")) -> df_phen_event

df_phen_event %>%
  mutate(Emerge = case_when(
    SpeciesID == "Acari" ~ "Early",
    SpeciesID == "ANMU" ~ "Late",
    SpeciesID == "Aphidoidea" ~ "Late",
    SpeciesID == "Chalcidoidea" ~ "Late",
    SpeciesID == "CHCE" ~ "Early",
    SpeciesID == "Coccoidea" ~ "Late",
    SpeciesID == "Collembola" ~ "Early",
    SpeciesID == "Culicidae" ~ "Late",
    SpeciesID == "Ichneumonidae" ~ "Late",
    SpeciesID == "Linyphiidae" ~ "Early",
    SpeciesID == "Lycosidae" ~ "Early",
    SpeciesID == "MYSC" ~ "Early",
    SpeciesID == "Nymphalidae" ~ "Late",
    SpeciesID == "Phoridae" ~ "Late",
    SpeciesID == "Scathophagidae" ~ "Late",
    SpeciesID == "Thomisidae" ~ "Early")) -> df_phen_event

df_phen_event %>%
  mutate(Trait = case_when(
    SpeciesID == "Acari" ~ "Surface",
    SpeciesID == "ANMU" ~ "Flying",
    SpeciesID == "Aphidoidea" ~ "Surface",
    SpeciesID == "Chalcidoidea" ~ "Flying",
    SpeciesID == "CHCE" ~ "Flying",
    SpeciesID == "Coccoidea" ~ "Surface",
    SpeciesID == "Collembola" ~ "Surface",
    SpeciesID == "Culicidae" ~ "Flying",
    SpeciesID == "Ichneumonidae" ~ "Flying",
    SpeciesID == "Linyphiidae" ~ "Surface",
    SpeciesID == "Lycosidae" ~ "Surface",
    SpeciesID == "MYSC" ~ "Flying",
    SpeciesID == "Nymphalidae" ~ "Flying",
    SpeciesID == "Phoridae" ~ "Flying",
    SpeciesID == "Scathophagidae" ~ "Flying",
    SpeciesID == "Thomisidae" ~ "Surface")) -> df_phen_event
```

We find strong collinearity between temperature and snowmelt for families in the snowbed plot (Art6) and Nymphalidae in one mesic heath plot (Art3). Therefore, we have to remove these observations from the data.

```{r}
df_phen_event <-
  df_phen_event[!(df_phen_event$Plot == "Art1" &
                    (df_phen_event$Order == "Decomposer")), ]
df_phen_event <-
  df_phen_event[!(df_phen_event$Plot == "Art6" &
                    (df_phen_event$Order == "Decomposer")), ]
df_phen_event <-
  df_phen_event[!(df_phen_event$Plot == "Art6" &
                    (df_phen_event$Order == "Predator")), ]
df_phen_event <-
  df_phen_event[!(df_phen_event$Plot == "Art1" &
                    (df_phen_event$Order == "Predator")), ]
df_phen_event <-
  df_phen_event[!(df_phen_event$Plot == "Art6" &
                    (df_phen_event$Order == "Parasitoid")), ]
df_phen_event <-
  df_phen_event[!(df_phen_event$Plot == "Art6" &
                    (df_phen_event$Order == "Mixed feeder")), ]
df_phen_event <-
  df_phen_event[!(df_phen_event$Plot == "Art3" &
                    (df_phen_event$SpeciesID == "Nymphalidae")), ]
df_phen_event <-
  df_phen_event[!(df_phen_event$SpeciesID == "Lygaeidae"), ]

df_phen_event <- subset(df_phen_event,!Plot == "Art6")
```

Assign habitat type.

```{r}
df_phen_event %>%
  mutate(
    Habitat = case_when(
      Plot == "Art1" ~ "Pond",
      Plot == "Art2" ~ "Wet fen",
      Plot == "Art3" ~ "Mesic heath",
      Plot == "Art4" ~ "Mesic heath",
      Plot == "Art5" ~ "Arid heath",
      Plot == "Art7" ~ "Arid heath"
    )
  ) -> df_phen_event
```

Remove taxa in the dataset for which we do not have enough data.

```{r}
df_phen_event$Order[is.na(df_phen_event$Order)] <- "NA"
df_phen_event <- subset(df_phen_event, Order != "NA")
```

Because the temperature variable is specific for each taxon-by-plot combination, we need to account for within subject variation. Other than that, we also have to add year as a covariate to detrend the model.

```{r}
df_phen_event$speciesplot <-
  as.factor(paste(df_phen_event$SpeciesID, df_phen_event$Plot))

df_phen_event$Peak_Temp_new <-
  df_phen_event$Peak_Temp30 - tapply(df_phen_event$Peak_Temp30, df_phen_event$speciesplot, mean)[df_phen_event$speciesplot]
df_phen_event$Onset_Temp_new <-
  df_phen_event$Onset_Temp30 - tapply(df_phen_event$Onset_Temp30, df_phen_event$speciesplot, mean)[df_phen_event$speciesplot]
df_phen_event$End_Temp_new <-
  df_phen_event$End_Temp30 - tapply(df_phen_event$End_Temp30, df_phen_event$speciesplot, mean)[df_phen_event$speciesplot]
```

First model tests effect of temperature and snowmelt on peak phenology.

```{r}

m.full <-
  lmer(
    Peak ~ 1 + Snowmelt + Peak_Temp_new + Year + (1 + Snowmelt + Peak_Temp_new |
                                                    SpeciesID) + (1 |
                                                                    Year) + (1 |
                                                                               Year:SpeciesID) + (1 |
                                                                                                    Plot) + (1 + Snowmelt + Peak_Temp_new |
                                                                                                               speciesplot),
    data = df_phen_event
  )
summary(m.full)
#This model does not converge. We need to decrease the complexity.

#Try removing the random year effect

m.full1 <-
  lmer(
    Peak ~ 1 + Snowmelt + Peak_Temp_new + Year + (1 + Snowmelt + Peak_Temp_new |
                                                    SpeciesID) + (1 |
                                                                    Year:SpeciesID) + (1 |
                                                                                         Plot) + (1 + Snowmelt + Peak_Temp_new |
                                                                                                    speciesplot),
    data = df_phen_event
  )
summary(m.full1)
#Still not converging

#Try removing effect of snowmelt on each taxa, because it's a main concern for temperature
m.full2 <-
  lmer(
    Peak ~ 1 + Snowmelt + Peak_Temp_new + Year + (1 + Peak_Temp_new |
                                                    SpeciesID) + (1 |
                                                                    Year:SpeciesID) + (1 |
                                                                                         Plot) + (1 + Peak_Temp_new | speciesplot),
    data = df_phen_event
  )
summary(m.full2)
#Still not converging

#Try forcing correlation parameters to zero
m.full3 <-
  lmer(
    Peak ~ 1 + Snowmelt + Peak_Temp_new + Year + (0 + Snowmelt + Peak_Temp_new |
                                                    SpeciesID) + (1 |
                                                                    Year) + (1 |
                                                                               Year:SpeciesID) + (1 |
                                                                                                    Plot) + (0 + Snowmelt + Peak_Temp_new |
                                                                                                               speciesplot),
    data = df_phen_event
  )
summary(m.full3)
#Not converging

#Simplified model with forced corellation parameters to zero
m.full4 <-
  lmer(
    Peak ~ 1 + Snowmelt + Peak_Temp_new + Year + (0 + Peak_Temp_new |
                                                    SpeciesID) + (1 |
                                                                    Year) + (1 |
                                                                               Year:SpeciesID) + (1 |
                                                                                                    Plot) + (0 + Peak_Temp_new | speciesplot),
    data = df_phen_event
  )
summary(m.full4)
#Model comparison shows that this model is really bad

#Try with a very simplified model without forcing correlation parameters to zero.
m.full5 <-
  lmer(
    Peak ~ 1 + Snowmelt + Peak_Temp_new + Year + (1 |
                                                    Plot) + (1 + Peak_Temp_new | speciesplot),
    data = df_phen_event
  )
#The model converges! But model is not as good as m.full. We do prefer a model that is not overparametrized, though.
summary(m.full5)

anova(m.full, m.full1, m.full2, m.full3, m.full4, m.full5)

```

Create table from effect of climate variables on community peak phenology.

```{r output=TRUE}
tab_model(m.full5, show.intercept = TRUE, show.est = TRUE, show.se = TRUE, show.p = TRUE, show.stat = TRUE, show.ci = FALSE,
         title = "Peak ~ Snowmelt + Temp + Year + (1 | Plot) + (1 + Temp | Taxa:Plot)", terms = c("(Intercept)", "Snowmelt", "Peak_Temp_new", "Year"), pred.labels = c("Intercept", "Snowmelt", "Temp", "Year"), dv.labels = "", string.est = "Coeff", string.se = "SE", string.stat = "t", string.p = "P-Value")
```

Full model for duration of activity of the arthropod community.

```{r}
m.full.dur <-
  lmer(
    Duration ~ 1 + Snowmelt + Onset_Temp_new + Year + (1 + Snowmelt + Onset_Temp_new |
                                                         SpeciesID) + (1 |
                                                                         Year) + (1 |
                                                                                    Year:SpeciesID) + (1 |
                                                                                                         Plot) + (1 + Snowmelt + Onset_Temp_new |
                                                                                                                    SpeciesID:Plot),
    data = df_phen_event
  )
summary(m.full.dur)
#Model does not converge 

#Try with a very simplified model without forcing correlation parameters to zero.
m.full.dur5 <-
  lmer(
    Duration ~ 1 + Snowmelt + Onset_Temp_new + Year + (1 |
                                                    Plot) + (1 + Onset_Temp_new | speciesplot),
    data = df_phen_event
  )
#The model converges! But model is not as good as m.full. We do prefer a model that is not overparametrized, though.
summary(m.full.dur5)

anova(m.full.dur, m.full.dur5)
```

```{r}
tab_model(m.full.dur5, show.intercept = TRUE, show.est = TRUE, show.se = TRUE, show.p = TRUE, show.stat = TRUE, show.ci = FALSE,
          terms = c("(Intercept)", "Snowmelt", "Onset_Temp_new", "Year"), 
          pred.labels = c("Intercept", "Snowmelt", "Temp", "Year"), title = "Duration ~ Snowmelt + Temp + Year (1 | Plot) + (1 + Temp | Taxa:Plot)", dv.labels = "", string.est = "Coeff", string.se = "SE", string.stat = "t", string.p = "P-Value")
```
